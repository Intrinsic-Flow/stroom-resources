#Defines all the services that make up the stroom estate
version: '2.1'

services:

  elasticsearch:
      extends:
          file: ./containers/elasticsearch.yml
          service: elasticsearch

  fake-smtp:
      extends:
          file: ./containers/fakeSmtp.yml
          service: fake-smtp

  hbase:
      extends:
          file: ./containers/hbase.yml
          service: hbase
      #override the hostname as stroom-stats will access it from inside the docker network
      #hostname: hbase
      depends_on:
        - zookeeper

  hdfs:
      extends:
          file: ./containers/hdfs.yml
          service: hdfs

  kafka:
      extends:
          file: ./containers/kafka.yml
          service: kafka
      depends_on:
        - zookeeper

  kibana:
      extends:
          file: ./containers/kibana.yml
          service: kibana
      depends_on:
          - elasticsearch


  nginx:
      extends:
          file: ./containers/nginx.yml
          service: nginx

  stroom:
      extends:
          file: ./containers/stroom.yml
          service: stroom
      #image: "gchq/stroom:${STROOM_TAG}"
      depends_on:
        - stroom-db
        - stroom-stats-db

  # Alternative to running stroom, run stroom with remote debugging enabled.
  stroom-debug:
      extends:
          file: ./containers/stroom.yml
          service: stroom
      #image: "gchq/stroom:${STROOM_TAG}"

      ## Additional arguments required ahead of the -jar to enable debugging
      command: ["java", "-agentlib:jdwp=transport=dt_socket,server=y,suspend=n,address=${STROOM_DEBUG_PORT}", "-jar", "stroom-app-all.jar", "server", "config.yml"]
      ports:
        - 8080:8080
        - 8081:8081
        - "${STROOM_DEBUG_PORT:-10765}:${STROOM_DEBUG_PORT:-10765}"
      depends_on:
        - stroom-db
        - stroom-stats-db

  stroom-annotations-db:
      extends:
          file: ./containers/stroomAnnotationsDb.yml
          service: stroom-annotations-db

  stroom-annotations-service:
      extends:
          file: ./containers/stroomAnnotationsService.yml
          service: stroom-annotations-service
      depends_on:
          - stroom-annotations-db

  stroom-annotations-ui:
      extends:
          file: ./containers/stroomAnnotationsUi.yml
          service: stroom-annotations-ui

  stroom-auth-service-db:
      extends:
          file: ./containers/stroomAuthDb.yml
          service: stroom-auth-db

  stroom-auth-service:
      extends:
          file: ./containers/stroomAuthService.yml
          service: stroom-auth-service
      depends_on:
          - stroom-auth-service-db

  stroom-auth-ui:
      extends:
          file: ./containers/stroomAuthUi.yml
          service: stroom-auth-ui

  stroom-db:
      extends:
          file: ./containers/stroomDb.yml
          service: stroom-db

  stroom-proxy:
      extends:
          file: ./containers/stroomProxy.yml
          service: stroom-proxy

  stroom-query-elastic-ui:
      extends:
          file: ./containers/stroomQueryElasticUi.yml
          service: stroom-query-elastic-ui

  stroom-query-elastic-service:
      extends:
          file: ./containers/stroomQueryElasticService.yml
          service: stroom-query-elastic-service

  stroom-stats:
      extends:
          file: ./containers/stroomStats.yml
          service: stroom-stats
      depends_on:
        - stroom-db
        - zookeeper
        - kafka
        - hbase

  stroom-stats-db:
      extends:
          file: ./containers/stroomStatsDb.yml
          service: stroom-stats-db

  zookeeper:
      extends:
          file: ./containers/zookeeper.yml
          service: zookeeper
