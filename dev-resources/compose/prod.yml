# Runs the whole stroom estate except for Cloudera
version: '2'

services: 

  stroom-db:
    image: mysql:5.6
    container_name: stroom-db
    ports:
      - "3307:3306"
    environment:
      - MYSQL_ROOT_PASSWORD=my-secret-pw
      - MYSQL_USER=stroomuser
      - MYSQL_PASSWORD=stroompassword1
      - MYSQL_DATABASE=stroom

  stroom-stats-db:
    image: mysql:5.6
    container_name: stroom-stats-db
    ports:
        #expose mysql on 3307 to the host so as not to conflict with stroom-db
      - "3308:3306"
    environment:
      - MYSQL_ROOT_PASSWORD=my-secret-pw
      - MYSQL_USER=stroomuser
      - MYSQL_PASSWORD=stroompassword1
      - MYSQL_DATABASE=statistics

  stroom-auth-db:
    image: mariadb:10.3.0
    container_name: stroom-auth-db
    ports:
        # Expose mysql on 3309 to the host so as not to conflict with stroom-db or stroom-stats-db
      - "3309:3306"
    environment:
      - MYSQL_ROOT_PASSWORD=my-secret-pw
      - MYSQL_USER=stroomuser
      - MYSQL_PASSWORD=stroompassword1
      - MYSQL_DATABASE=auth

  stroom-auth-service:
    container_name: stroom-auth-service
    image: gchq/stroom-auth-service:v0.1.1-alpha
    environment:
      - DB_USER=stroomuser
      - DB_PASSWORD=stroompassword1
      - DB_URL=jdbc:mariadb://stroom-auth-db/auth
      - JWS_SECRET=CHANGE_ME
      - ADMIN_CONTEXT_PATH=/authenticationServiceAdmin
      - AUTH_UI=http://localhost/auth/login
    ports:
      - 8099:8099
      - 8100:8100

  stroom-auth-ui:
    container_name: stroom-auth-ui
    image: gchq/stroom-auth-ui:v0.1.1-alpha
    environment:
      - REACT_APP_STROOM_AUTH_SERVICE_URL=http://stroom-auth-service:8096
      - REACT_APP_STROOM_UI_URL=http://stroom:8080
    ports:
      - 5000:5000

  stroom-apigateway:
    container_name: stroom-apigateway
    imange: gchq/stroom-apigateway:latest
    ports:
      - "80:80"
      - "443:443"

  stroom-stats:
    container_name: stroom-stats
    image: gchq/stroom-stats:auth_v0.1.1-alpha
    environment:
      - STATS_DB_USER=stroomuser
      - STATS_DB_PASSWORD=stroompassword1
      - STATS_DB_URL=jdbc:mysql://stroom-db/stroom?useUnicode=yes&characterEncoding=UTF-8
      - STATS_JWT_SECRET=CHANGE_ME
      - STATS_ZK_QUORUM=zookeeper:2181
      # The below two values change the default properties - they don't actually set them in ZK!
      # That is, once these have been set changing the below won't change them. You'd need to do that directly
        # on zk, using the CLI or some GUI.
      - STATS_KAFKA_BOOTSTRAP=kafka:9092
      - STATS_HBASE_ZK_QUORUM=zookeeper:2181
      - ADMIN_CONTEXT_PATH=/statsAdmin
    ports:
      - 8086:8086 # app
      - 8087:8087 # admin

  stroom:
    container_name: stroom
    image: gchq/stroom:auth_v0.1.1-alpha
    environment:
      - STROOM_NODE=node1a
      - STROOM_RACK=rack
      - STROOM_JPA_DIALECT=org.hibernate.dialect.MySQLInnoDBDialect
      - STROOM_JDBC_DRIVER_CLASS_NAME=com.mysql.jdbc.Driver
      - STROOM_JDBC_DRIVER_URL=jdbc:mysql://stroom-db/stroom?useUnicode=yes&characterEncoding=UTF-8
      - STROOM_JDBC_DRIVER_USERNAME=stroomuser
      - STROOM_JDBC_DRIVER_PASSWORD=stroompassword1
      - STROOM_STATISTICS_SQL_JDBC_DRIVER_URL=jdbc:mysql://stroom-stats-db/statistics?useUnicode=yes&characterEncoding=UTF-8
      - STROOM_STATISTICS_SQL_JDBC_DRIVER_USERNAME=stroomuser
      - STROOM_STATISTICS_SQL_JDBC_DRIVER_PASSWORD=stroompassword1
      - STROOM_KAFKA_BOOTSTRAP_SERVERS=kafka:9092
      - STROOM_SECURITY_LOGIN_URL=http://localhost/authenticationService/v1/checkCertificate
      - STROOM_SERVICE_DISCOVERY_ZOOKEEPER_URL=zookeeper:2181
      - STROOM_AUTH_JWT_SECRET=CHANGE_ME
      - ADMIN_CONTEXT_PATH=/stroomAdmin
    ports:
      - 8080:8080
      - 8081:8081
