version: '2.1'

services:

  stroom-auth-service:
    container_name: stroom-auth-service
    image: "${STROOM_AUTH_SERVICE_DOCKER_REPO:-gchq/stroom-auth-service}:${STROOM_AUTH_SERVICE_TAG:-v0.1-LATEST}"
    environment:
      - STROOM_AUTH_SERVICE_PORT=${STROOM_AUTH_SERVICE_PORT:-8099}
      - STROOM_AUTH_SERVICE_ADMIN_PORT=${STROOM_AUTH_SERVICE_ADMIN_PORT:-8100}
      - DB_USER=${STROOM_AUTH_DB_USERNAME:-stroomuser}
      - DB_PASSWORD=${STROOM_AUTH_DB_PASSWORD:-stroompassword1}
      - DB_URL=jdbc:mariadb://${STROOM_AUTH_DB_HOST:-stroom-auth-db}:${STROOM_AUTH_DB_PORT:-3306}/auth
      - JWS_ISSUER=stroom
      - ADMIN_CONTEXT_PATH=/authenticationServiceAdmin
      - ADVERTISED_HTTP_HOST=http://${STROOM_AUTH_SERVICE_HOST:-stroom-auth-service}/authService
      - AUTH_UI=${STROOM_AUTH_UI_URL:-http://localhost:5000}/login
      - CHANGE_PASSWORD_URL=${STROOM_AUTH_UI_URL:-http://localhost:5000}/changePassword
      - AUTHORISATION_SERVICE_URL=http://${STROOM_AUTHORISATION_SERVICE_HOST:-stroom}/authorisationService/v1
      - AUTHORISATION_SERVICE_CAN_MANAGE_USERS_PATH=/canManageUsers
      - AUTHORISATION_SERVICE_CAN_MANAGE_USERS_PERMISSION=Manage Users
      - JWS_MINUTES_UNTIL_EXPIRATION_FOR_USER_TOKEN=43200 # 43200 minutes = 30 days
      - JWS_MINUTES_UNTIL_EXPIRATION_FOR_API_TOKEN=525600 # 525600 minutes = 1 year
      - JWS_MINUTES_UNTIL_EXPIRATION_FOR_EMAIL_RESET_TOKEN=5 # Only 5 minutes
      - EMAIL_FROM_ADDRESS=${EMAIL_FROM_ADDRESS:-TODO}
      - EMAIL_FROM_NAME=${EMAIL_FROM_NAME:-Stroom User Accounts}
      - EMAIL_RESET_SUBJECT=${EMAIL_RESET_SUBJECT:-Password reset for Stroom}
      - EMAIL_RESET_TEXT=${EMAIL_RESET_TEXT:-A password reset has been requested for this email address. Please visit the following URL to reset your password -- %s.}
      - EMAIL_RESET_TOKEN_VALIDITY_IN_MINUTES=${EMAIL_RESET_TOKEN_VALIDITY_IN_MINUTES:-60}
      - EMAIL_SMTP_HOST=${EMAIL_SMTP_HOST:-TODO}
      - EMAIL_SMTP_PORT=${EMAIL_SMTP_PORT:-587}
      - EMAIL_SMTP_TRANSPORT=${EMAIL_SMTP_TRANSPORT:-TLS}
      - EMAIL_SMTP_USERNAME=${EMAIL_SMTP_USERNAME:-TODO}
      - EMAIL_SMTP_PASSWORD=${EMAIL_SMTP_PASSWORD:-TODO}
    ports:
      - "${STROOM_AUTH_SERVICE_PORT:-8099}:${STROOM_AUTH_SERVICE_PORT:-8099}"
      - "${STROOM_AUTH_SERVICE_ADMIN_PORT:-8100}:${STROOM_AUTH_SERVICE_ADMIN_PORT:-8100}"
    entrypoint: ./wait-for-it_busybox.sh ${STROOM_AUTH_DB_HOST:-stroom-auth-db}:${STROOM_AUTH_DB_PORT:-3306} -- java -jar stroom-auth-service-all.jar server config.yml
